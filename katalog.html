<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katalog Wisata - GoTravel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --primary: #FF5733; --text-dark: #2D3436; }
        body { font-family: 'Fredoka', sans-serif; background-color: #f8fafc; color: var(--text-dark); }
        .photo-slider-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; width: 100%; height: 100%; -webkit-overflow-scrolling: touch; }
        .photo-slider-container::-webkit-scrollbar { display: none; }
        .photo-slide { flex: 0 0 100%; width: 100%; height: 100%; scroll-snap-align: start; }
        .photo-slide img { width: 100%; height: 100%; object-fit: cover; }
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: white/90; border-radius: 99px; padding: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 20; cursor: pointer; }
        #map-container { width: 100%; height: 250px; border-radius: 1.5rem; overflow: hidden; background: #eee; margin-top: 1rem; }
        .detail-panel { transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1); transform: translateY(100%); }
        .detail-panel.open { transform: translateY(0); }
        .price-option { padding: 12px; border: 2px solid #f1f5f9; border-radius: 1rem; cursor: pointer; display: flex; justify-content: space-between; transition: 0.2s; }
        .price-option.active { border-color: var(--primary); background: #fff7ed; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .qty-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 10px; border: 1px solid #ddd; background: white; font-weight: bold; }
        .qty-btn:hover { background: #FF5733; color: white; border-color: #FF5733; }
    </style>
</head>
<body class="antialiased">

    <nav class="fixed w-full z-40 px-6 py-4">
        <div class="max-w-7xl mx-auto bg-white/90 backdrop-blur-md rounded-full px-6 py-3 flex justify-between items-center shadow-lg border border-slate-100">
            <a href="index.html" class="flex items-center gap-2 font-bold text-xl uppercase tracking-tighter">
                <span class="text-slate-900">GO!</span><span style="color:var(--primary)">TRAVEL</span>
            </a>
            <button onclick="showCartPreview()" class="relative p-3 bg-slate-900 rounded-2xl text-white">
                <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-orange-600 text-[10px] font-bold w-6 h-6 rounded-full border-2 border-white flex items-center justify-center">0</span>
            </button>
        </div>
    </nav>

    <main class="pt-32 px-6 max-w-7xl mx-auto pb-20">
        <h1 class="text-4xl font-bold mb-8">Pilih <span style="color:var(--primary)" class="italic">Petualanganmu.</span></h1>
        <div id="category-filter" class="flex gap-2 overflow-x-auto no-scrollbar mb-10 pb-2"></div>
        <div id="katalog-container" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
    </main>

    <div id="detail-overlay" class="fixed inset-0 bg-slate-950/60 z-50 hidden backdrop-blur-sm flex items-end">
        <div class="absolute inset-0" onclick="closeDetail()"></div>
        <div class="detail-panel relative w-full bg-white rounded-t-[3rem] max-h-[92vh] overflow-y-auto p-8 no-scrollbar">
            <button onclick="closeDetail()" class="absolute top-6 right-6 p-2 bg-slate-100 rounded-full z-[60]"><i data-lucide="x"></i></button>
            <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-10">
                <div class="space-y-6">
                    <div class="relative w-full h-72 rounded-[2.5rem] overflow-hidden shadow-xl bg-slate-100">
                        <button onclick="slidePrev()" class="nav-btn left-4"><i data-lucide="chevron-left"></i></button>
                        <button onclick="slideNext()" class="nav-btn right-4"><i data-lucide="chevron-right"></i></button>
                        <div id="photo-slider" class="photo-slider-container"></div>
                    </div>
                    <div id="map-container"></div>
                </div>
                <div class="flex flex-col text-left">
                    <h2 id="detail-title" class="text-2xl font-bold mb-4"></h2>
                    <div class="bg-slate-50 p-5 rounded-2xl border border-slate-200 mb-4">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Detail Paket</p>
                        <div id="detail-desc" class="text-sm text-slate-600 max-h-32 overflow-y-auto pr-2"></div>
                    </div>
                    
                    <div class="space-y-2 mb-6">
                        <div onclick="selectPrice(0)" id="opt-0" class="price-option"><span>Driver Only</span><span id="price-h1" class="font-bold"></span></div>
                        <div onclick="selectPrice(1)" id="opt-1" class="price-option"><span>Driver as Guide</span><span id="price-h2" class="font-bold"></span></div>
                        <div onclick="selectPrice(2)" id="opt-2" class="price-option"><span>Driver & Guide</span><span id="price-h3" class="font-bold"></span></div>
                    </div>

                    <div class="flex items-center justify-between mb-8 p-4 bg-orange-50 rounded-2xl border border-orange-100">
                        <div>
                            <span class="text-xs font-bold text-orange-800 block">Jumlah Orang</span>
                            <span id="promo-tag" class="text-[10px] text-orange-600 italic font-semibold">Semakin banyak semakin hemat!</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <button onclick="changeQty(-1)" class="qty-btn">-</button>
                            <span id="qty-display" class="font-bold text-lg">1</span>
                            <button onclick="changeQty(1)" class="qty-btn">+</button>
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-6 border-t">
                        <div>
                            <p id="label-per-orang" class="text-[10px] font-bold text-slate-400"></p>
                            <h4 id="display-total" class="text-xl font-bold text-slate-900"></h4>
                        </div>
                        <button onclick="addToCart()" class="bg-orange-600 text-white px-10 py-4 rounded-2xl font-bold shadow-lg">Tambah ke Bag</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfBQUIIfKjIbRQLSyH8zKIA9hhIEvf85GKTgtPcGttz_bnzEMpgUcxd4ej1LVQGLOyPQ/exec"; 
        let allData = [], filteredData = [], currentPaket = null, selectedIdx = 0, currentQty = 1, cart = [];

        async function init() {
            try {
                const res = await fetch(SCRIPT_URL + "?action=sync");
                const result = await res.json();
                allData = result.produk;
                filteredData = [...allData];
                const savedCart = localStorage.getItem('travel_cart');
                if(savedCart) cart = JSON.parse(savedCart);
                updateCartBadge();
                renderFilters(); renderKatalog();
            } catch (e) { console.error("Load Error"); }
            lucide.createIcons();
        }

        // LOGIKA DISKON PROGRESIF
        function calculatePrice(basePrice, qty) {
            let discount = 0;
            if (qty === 2) discount = 0.35; // Diskon 35% per orang
            else if (qty === 3) discount = 0.40; // Diskon 40% per orang
            else if (qty === 4) discount = 0.45; // Diskon 45% per orang
            
            let pricePerPerson = basePrice * (1 - discount);
            return {
                perPerson: Math.round(pricePerPerson),
                total: Math.round(pricePerPerson * qty),
                discountPercent: discount * 100
            };
        }

        function updateTotalPriceDisplay() {
            const prices = currentPaket.harga.split(',');
            const basePrice = parseInt(prices[selectedIdx] || 0);
            const calc = calculatePrice(basePrice, currentQty);

            document.getElementById('label-per-orang').innerText = currentQty > 1 ? `Rp ${calc.perPerson.toLocaleString('id-ID')} / ORANG` : "TOTAL HARGA";
            document.getElementById('display-total').innerText = "Rp " + calc.total.toLocaleString('id-ID');
            document.getElementById('promo-tag').innerText = calc.discountPercent > 0 ? `Hemat ${calc.discountPercent}% per orang!` : "Semakin banyak semakin hemat!";
        }

        function renderFilters() {
            const filterBox = document.getElementById('category-filter');
            const cats = ['Semua', ...new Set(allData.map(p => p.kategori).filter(k => k && k !== '-'))];
            filterBox.innerHTML = cats.map(c => `<button onclick="filterBy('${c}')" class="px-6 py-2 rounded-full border text-xs font-bold transition whitespace-nowrap shadow-sm bg-white text-slate-500">${c}</button>`).join('');
        }

        function filterBy(cat) {
            filteredData = (cat === 'Semua') ? allData : allData.filter(p => p.kategori === cat);
            renderKatalog();
        }

        function renderKatalog() {
            const container = document.getElementById('katalog-container');
            container.innerHTML = filteredData.map((p, i) => `
                <div class="bg-white rounded-[2rem] p-4 shadow-sm hover:shadow-xl transition cursor-pointer group" onclick="openDetail(${i})">
                    <div class="overflow-hidden rounded-[1.5rem] mb-4 h-52">
                        <img src="${p.foto.split(',')[0].trim()}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                    </div>
                    <h3 class="text-lg font-bold text-slate-800 truncate px-2">${p.judul}</h3>
                    <p class="text-orange-600 font-bold mt-2 px-2">Rp ${parseInt(p.harga.split(',')[0]).toLocaleString('id-ID')}</p>
                </div>`).join('');
        }

        function openDetail(idx) {
            currentPaket = filteredData[idx];
            currentQty = 1;
            document.getElementById('qty-display').innerText = currentQty;
            renderSlider(currentPaket.foto);
            document.getElementById('detail-title').innerText = currentPaket.judul;
            document.getElementById('detail-desc').innerText = currentPaket.deskripsi;
            document.getElementById('map-container').innerHTML = currentPaket.map || "";
            const p = currentPaket.harga.split(',');
            ['h1','h2','h3'].forEach((id, i) => document.getElementById('price-'+id).innerText = "Rp " + parseInt(p[i] || 0).toLocaleString('id-ID'));
            selectPrice(0);
            document.getElementById('detail-overlay').classList.remove('hidden');
            setTimeout(() => document.querySelector('.detail-panel').classList.add('open'), 50);
        }

        function changeQty(val) {
            if (currentQty + val >= 1 && currentQty + val <= 4) {
                currentQty += val;
                document.getElementById('qty-display').innerText = currentQty;
                updateTotalPriceDisplay();
            }
        }

        function selectPrice(idx) {
            selectedIdx = idx;
            document.querySelectorAll('.price-option').forEach(el => el.classList.remove('active'));
            document.getElementById('opt-' + idx).classList.add('active');
            updateTotalPriceDisplay();
        }

        function closeDetail() {
            document.querySelector('.detail-panel').classList.remove('open');
            setTimeout(() => document.getElementById('detail-overlay').classList.add('hidden'), 500);
        }

        function renderSlider(foto) {
            document.getElementById('photo-slider').innerHTML = foto.split(',').map(url => `<div class="photo-slide"><img src="${url.trim()}"></div>`).join('');
        }

        function slideNext() { document.getElementById('photo-slider').scrollBy({left: 300, behavior: 'smooth'}); }
        function slidePrev() { document.getElementById('photo-slider').scrollBy({left: -300, behavior: 'smooth'}); }

        function addToCart() {
            const variantNames = ["Driver Only", "Driver as Guide", "Driver & Guide"];
            const base = parseInt(currentPaket.harga.split(',')[selectedIdx]);
            const calc = calculatePrice(base, currentQty);
            cart.push({ judul: currentPaket.judul, varian: variantNames[selectedIdx], qty: currentQty, harga: calc.total });
            localStorage.setItem('travel_cart', JSON.stringify(cart));
            updateCartBadge(); closeDetail();
            Swal.fire({ icon: 'success', title: 'Berhasil!', text: 'Masuk ke bag', timer: 1000, showConfirmButton: false });
        }

        function updateCartBadge() { document.getElementById('cart-count').innerText = cart.length; }

        function showCartPreview() {
            if(cart.length === 0) return Swal.fire('Kosong', 'Bag Anda masih kosong.', 'info');
            let total = cart.reduce((sum, item) => sum + item.harga, 0);
            let cartHtml = cart.map((item, index) => `
                <div class="flex justify-between items-center p-3 mb-2 bg-slate-50 rounded-xl border border-slate-200 text-left">
                    <div><p class="font-bold text-xs">${item.judul}</p><p class="text-[10px] text-slate-500">${item.varian} x${item.qty}</p><p class="text-[10px] font-bold text-orange-600">Rp ${item.harga.toLocaleString('id-ID')}</p></div>
                    <button onclick="removeItem(${index})" class="p-2 text-red-500 bg-white rounded-lg shadow-sm"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`).join('');
            Swal.fire({
                title: 'Isi Bag Anda',
                html: `<div class="max-h-60 overflow-y-auto mb-4 no-scrollbar">${cartHtml}</div><div class="flex justify-between items-center px-2 py-3 border-t font-bold"><span>Total:</span><span class="text-orange-600">Rp ${total.toLocaleString('id-ID')}</span></div>`,
                showCancelButton: true, confirmButtonText: 'Lanjut Reservasi', cancelButtonText: 'Belanja Lagi', confirmButtonColor: '#FF5733', reverseButtons: true,
                didOpen: () => lucide.createIcons()
            }).then((result) => { if (result.isConfirmed) showReservationForm(); });
        }

        function removeItem(index) {
            cart.splice(index, 1);
            localStorage.setItem('travel_cart', JSON.stringify(cart));
            updateCartBadge();
            if(cart.length > 0) showCartPreview(); else Swal.close();
        }

        async function showReservationForm() {
            let total = cart.reduce((sum, item) => sum + item.harga, 0);
            const { value: formValues } = await Swal.fire({
                title: 'Data Reservasi',
                html: `<div class="grid grid-cols-1 gap-2">
                    <input id="swal-nama" class="swal2-input !m-0 !w-full" placeholder="Nama Lengkap">
                    <div class="flex gap-2"><input id="swal-negara" class="swal2-input !m-0 !w-full" placeholder="Negara"><input id="swal-kota" class="swal2-input !m-0 !w-full" placeholder="Kota Asal"></div>
                    <input type="number" id="swal-wa" class="swal2-input !m-0 !w-full" placeholder="WhatsApp (62...)">
                    <div class="flex gap-2"><input type="date" id="swal-tgl" class="swal2-input !m-0 !w-full"><input id="swal-id" class="swal2-input !m-0 !w-full" placeholder="KTP/Paspor"></div>
                    <textarea id="swal-catatan" class="swal2-textarea !m-0 !w-full" placeholder="Catatan"></textarea>
                </div>`,
                confirmButtonText: 'Kirim Pesanan', confirmButtonColor: '#FF5733', showCancelButton: true,
                preConfirm: () => { return { nama: document.getElementById('swal-nama').value, negara: document.getElementById('swal-negara').value, kota: document.getElementById('swal-kota').value, wa: document.getElementById('swal-wa').value, tgl: document.getElementById('swal-tgl').value, id: document.getElementById('swal-id').value, catatan: document.getElementById('swal-catatan').value }; }
            });
            if (formValues && formValues.nama && formValues.wa) processCheckout(formValues, total);
        }

        async function processCheckout(userData, total) {
            Swal.fire({ title: 'Memproses...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const orderId = 'TRV-' + Date.now().toString().slice(-6);
            const payload = { action: "addOrder", orderId: orderId, nama: userData.nama, negara: userData.negara, kotaAsal: userData.kota, whatsapp: userData.wa, tanggalTrip: userData.tgl, noIdentitas: userData.id, catatan: userData.catatan, items: cart.map(i => `${i.judul} (${i.varian} x${i.qty})`).join(', '), total: total };
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();
                if(result.status === 'success') {
                    Swal.fire({ title: 'Berhasil!', html: `ID: <b>${orderId}</b><br>BCA 1234567890<br>GoTravel Indonesia`, confirmButtonText: 'Konfirmasi WA', confirmButtonColor: '#25D366' })
                    .then(() => {
                        window.open(`https://wa.me/6281234567890?text=Halo! Pesanan: ${orderId}%0ANama: ${userData.nama}%0ATotal: Rp ${total.toLocaleString('id-ID')}`, '_blank');
                        cart = []; localStorage.removeItem('travel_cart'); location.reload();
                    });
                }
            } catch (err) { Swal.fire('Error', 'Gagal kirim data.', 'error'); }
        }
        window.onload = init;
    </script>
</body>
</html>