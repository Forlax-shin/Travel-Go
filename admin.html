<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin - GoTravel Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Fredoka', sans-serif; background: #f8fafc; color: #1e293b; height: 100vh; overflow: hidden; }
        .tab-content { display: none; height: 100vh; overflow-y: auto; padding-bottom: 80px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #auth-overlay { position: fixed; inset: 0; z-index: 9999; background: white; display: flex; align-items: center; justify-content: center; }
        .auth-card { @apply w-full max-w-md p-10 bg-white rounded-[3rem] border border-slate-100 shadow-2xl shadow-orange-100/50 text-center; }

        .sidebar-item { @apply flex flex-col items-center justify-center gap-2 w-full py-5 rounded-2xl font-bold text-slate-400 transition-all hover:bg-slate-50 text-center cursor-pointer; }
        .sidebar-item i { @apply w-5 h-5; }
        .sidebar-item span { @apply text-[9px] uppercase tracking-widest; }
        .sidebar-item.active { @apply bg-orange-500 text-white shadow-lg shadow-orange-200; }
        
        .form-container { @apply flex flex-col gap-6 max-w-5xl bg-white p-10 rounded-[2.5rem] border border-slate-100 shadow-sm mx-auto mb-10; }
        .input-group { @apply flex flex-col gap-2 w-full; }
        .input-box { @apply w-full px-5 py-3.5 rounded-xl border border-slate-200 bg-slate-50/50 focus:border-orange-500 focus:bg-white focus:ring-4 focus:ring-orange-500/10 outline-none transition-all text-sm; }
        .label-text { @apply text-[10px] font-bold text-slate-500 uppercase tracking-wider ml-1; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="flex">

    <div id="auth-overlay">
        <div class="auth-card">
            <div class="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center text-white shadow-lg mx-auto mb-6">
                <i data-lucide="shield-check" class="w-8 h-8"></i>
            </div>
            <h2 id="auth-title" class="text-3xl font-bold mb-2 text-slate-800">Login Admin</h2>
            <p id="auth-desc" class="text-slate-400 text-sm mb-8">Masukkan akses untuk mengelola GoTravel</p>
            <div class="space-y-4">
                <input type="text" id="auth-user" placeholder="Username" class="input-box">
                <input type="password" id="auth-pass" placeholder="Password" class="input-box">
                <button onclick="handleAuth()" id="auth-btn" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:scale-105 transition-all">Masuk Sekarang</button>
                <p class="text-xs text-slate-400 mt-6">
                    <span id="auth-switch-text">Belum punya akun?</span> 
                    <button onclick="switchAuth()" id="auth-switch-btn" class="text-orange-500 font-bold underline">Daftar Admin</button>
                </p>
            </div>
        </div>
    </div>

    <aside class="w-24 bg-white border-r border-slate-100 flex flex-col items-center py-6 shrink-0 h-screen">
        <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center text-white shadow-lg mb-12">
            <i data-lucide="layout-dashboard"></i>
        </div>
        <nav class="flex-1 w-full px-3 space-y-2">
            <button onclick="showTab('dashboard')" id="btn-dashboard" class="sidebar-item active"><i data-lucide="bar-chart-3"></i><span>Stats</span></button>
            <button onclick="showTab('paket')" id="btn-paket" class="sidebar-item"><i data-lucide="map"></i><span>Paket</span></button>
            <button onclick="showTab('tim')" id="btn-tim" class="sidebar-item"><i data-lucide="users"></i><span>Tim</span></button>
            <button onclick="showTab('gallery')" id="btn-gallery" class="sidebar-item"><i data-lucide="camera"></i><span>Galeri</span></button>
            <button onclick="showTab('berita')" id="btn-berita" class="sidebar-item"><i data-lucide="newspaper"></i><span>Berita</span></button>
        </nav>
        <button onclick="handleLogout()" class="mt-auto mb-2 p-3 text-red-400 hover:bg-red-50 rounded-xl transition">
            <i data-lucide="log-out"></i>
        </button>
    </aside>

    <main class="flex-1 overflow-y-auto custom-scroll relative bg-[#fcfcfd]">
        
        <div id="tab-dashboard" class="tab-content active p-12">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <p class="text-orange-500 font-bold tracking-widest text-xs mb-1 uppercase">Laporan Performa</p>
                    <h1 class="text-4xl font-bold tracking-tighter text-slate-800">Statistik <span class="text-slate-300">Periode</span></h1>
                </div>
            </div>

            <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm mb-8">
                <div class="flex flex-wrap items-end gap-4">
                    <div class="flex-1 min-w-[200px]">
                        <label class="label-text mb-2">Dari Tanggal</label>
                        <input type="date" id="filter-start" class="input-box cursor-pointer">
                    </div>
                    <div class="flex-1 min-w-[200px]">
                        <label class="label-text mb-2">Sampai Tanggal</label>
                        <input type="date" id="filter-end" class="input-box cursor-pointer">
                    </div>
                    <button onclick="applyFilter()" class="h-[50px] px-8 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition flex items-center gap-2">
                        <i data-lucide="filter" class="w-4 h-4"></i> Tampilkan
                    </button>
                    <div class="flex gap-2">
                        <button onclick="setQuickDate('thisMonth')" class="h-[50px] px-4 bg-orange-50 text-orange-600 border border-orange-100 rounded-xl font-bold text-xs hover:bg-orange-100 transition">Bulan Ini</button>
                        <button onclick="setQuickDate('lastMonth')" class="h-[50px] px-4 bg-slate-50 text-slate-500 border border-slate-100 rounded-xl font-bold text-xs hover:bg-slate-100 transition">Bulan Lalu</button>
                    </div>
                </div>
                <p class="text-[10px] text-slate-400 mt-3 italic">* Maksimal rentang waktu 1 bulan untuk detail harian.</p>
            </div>

            <div class="grid grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="p-2 bg-orange-100 text-orange-500 rounded-lg"><i data-lucide="shopping-cart" class="w-5 h-5"></i></div>
                        <p class="label-text text-slate-400">Total Pesanan (Periode Ini)</p>
                    </div>
                    <h2 id="stat-sales" class="text-5xl font-bold tracking-tighter text-slate-800">0</h2>
                    <p class="text-xs text-slate-400 mt-2">Transaksi berhasil diproses</p>
                </div>
                <div class="bg-slate-900 p-8 rounded-[2rem] text-white shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-10 opacity-10">
                        <i data-lucide="wallet" class="w-32 h-32"></i>
                    </div>
                    <div class="relative z-10">
                        <p class="label-text mb-2 text-slate-500">Total Pendapatan (Periode Ini)</p>
                        <h2 id="stat-revenue" class="text-4xl font-bold text-orange-500 tracking-tighter">Rp 0</h2>
                        <p class="text-xs text-slate-500 mt-2">Akumulasi pendapatan kotor</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-8 rounded-[2rem] border border-slate-100 h-[450px] shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-700">Grafik Pesanan Harian</h3>
                    <div class="flex gap-2 text-[10px] font-bold uppercase tracking-widest text-slate-400">
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-orange-500"></div> Pesanan</span>
                    </div>
                </div>
                <div class="h-[350px]">
                    <canvas id="orderChart"></canvas>
                </div>
            </div>
        </div>

        <div id="tab-paket" class="tab-content p-12">
            <h2 class="text-3xl font-bold text-center mb-10 text-slate-800">Update <span class="text-orange-500">Paket Wisata</span></h2>
            <div class="form-container">
                <div class="grid grid-cols-2 gap-5">
                    <div class="input-group"><label class="label-text">Kategori Wilayah</label><input type="text" id="p-kat" class="input-box" placeholder="Bali Selatan"></div>
                    <div class="input-group"><label class="label-text">Judul Paket</label><input type="text" id="p-judul" class="input-box" placeholder="Private Trip Uluwatu"></div>
                </div>
                <div class="input-group">
                    <label class="label-text">Link Iframe Google Maps (Sematkan Peta)</label>
                    <input type="text" id="p-map" class="input-box" placeholder='Paste link <iframe> di sini...'>
                </div>
                <div class="input-group"><label class="label-text">Deskripsi Lengkap Itinerary</label><textarea id="p-desc" class="input-box h-32 w-full resize-none" placeholder="Masukkan rincian itinerary..."></textarea></div>
                <div class="grid grid-cols-3 gap-5">
                    <div class="input-group"><label class="label-text">Driver Only (Rp)</label><input type="number" id="p-h1" class="input-box" placeholder="0"></div>
                    <div class="input-group"><label class="label-text">Driver as Guide (Rp)</label><input type="number" id="p-h2" class="input-box" placeholder="0"></div>
                    <div class="input-group"><label class="label-text">Driver & Guide (Rp)</label><input type="number" id="p-h3" class="input-box" placeholder="0"></div>
                </div>
                <div class="grid grid-cols-2 gap-5">
                    <div class="input-group">
                        <label class="label-text">URL Foto Paket</label>
                        <div id="p-photo-slots" class="space-y-2"><input type="text" class="input-box p-photo-url" placeholder="https://image-link.com/foto1.jpg"></div>
                        <button onclick="addSlot('p-photo-slots', 'p-photo-url')" class="w-max mt-2 text-orange-500 font-bold text-[10px] hover:underline uppercase">+ Tambah Link Foto</button>
                    </div>
                    <div class="input-group">
                        <label class="label-text">Status Best Seller</label>
                        <select id="p-best" class="input-box"><option value="no">Biasa</option><option value="yes">⭐ Best Seller</option></select>
                    </div>
                </div>
                <button onclick="saveData('paket')" id="btn-save-paket" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-bold shadow-lg mt-4 transition-all hover:scale-[1.02] active:scale-95">Simpan Paket Wisata</button>
            </div>
        </div>

        <div id="tab-tim" class="tab-content p-12">
            <h2 class="text-3xl font-bold text-center mb-10 text-slate-800">Data <span class="text-orange-500">Tim Inti</span></h2>
            <div class="form-container max-w-2xl">
                <div class="input-group"><label class="label-text">Nama Lengkap</label><input type="text" id="t-nama" class="input-box"></div>
                <div class="input-group"><label class="label-text">Jabatan</label><input type="text" id="t-jab" class="input-box"></div>
                <div class="input-group"><label class="label-text">URL Foto Profil</label><input type="text" id="t-foto" class="input-box" placeholder="https://..."></div>
                <button onclick="saveData('tim')" id="btn-save-tim" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-black transition-all">Simpan Anggota</button>
            </div>
        </div>

        <div id="tab-gallery" class="tab-content p-12">
            <h2 class="text-3xl font-bold text-center mb-10 text-slate-800">Update <span class="text-orange-500">Galeri Momen</span></h2>
            <div class="form-container max-w-3xl">
                <div class="grid grid-cols-2 gap-5">
                    <div class="input-group"><label class="label-text">Kategori</label><input type="text" id="g-kat" class="input-box" placeholder="Bali Trip"></div>
                    <div class="input-group"><label class="label-text">Produk/Nama Lokasi</label><input type="text" id="g-produk" class="input-box" placeholder="Nusa Penida"></div>
                </div>
                <div class="input-group"><label class="label-text">URL Foto Galeri</label><input type="text" id="g-foto" class="input-box" placeholder="https://..."></div>
                <button onclick="saveData('gallery')" id="btn-save-gallery" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg">Upload ke Galeri</button>
            </div>
        </div>

        <div id="tab-berita" class="tab-content p-12">
            <h2 class="text-3xl font-bold text-center mb-10 text-slate-800">Posting <span class="text-orange-500">Berita & Blog</span></h2>
            <div class="form-container">
                <div class="grid grid-cols-2 gap-5">
                    <div class="input-group"><label class="label-text">Judul Berita</label><input type="text" id="b-judul" class="input-box" placeholder="Tips Liburan Hemat..."></div>
                    <div class="input-group"><label class="label-text">Kategori</label><input type="text" id="b-kategori" class="input-box" placeholder="Travel Tips"></div>
                </div>
                <div class="input-group">
                    <label class="label-text">URL Foto Berita</label>
                    <div id="b-photo-slots" class="space-y-2"><input type="text" class="input-box b-photo-url" placeholder="https://..."></div>
                    <button onclick="addSlot('b-photo-slots', 'b-photo-url')" class="w-max mt-2 text-orange-500 font-bold text-[10px] uppercase tracking-wider">+ Tambah Link Foto</button>
                </div>
                <div class="input-group"><label class="label-text">Isi Berita</label><textarea id="b-isi" class="input-box h-64 w-full resize-none" placeholder="Tulis artikel di sini..."></textarea></div>
                <button onclick="saveData('berita')" id="btn-save-berita" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-bold shadow-lg transition-all hover:scale-[1.02]">Terbitkan Berita Sekarang</button>
            </div>
        </div>

    </main>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfBQUIIfKjIbRQLSyH8zKIA9hhIEvf85GKTgtPcGttz_bnzEMpgUcxd4ej1LVQGLOyPQ/exec"; 
        
        let orderChartInstance;
        let isLoginMode = true;

        function setQuickDate(type) {
            const now = new Date();
            let start, end;
            if (type === 'thisMonth') {
                start = new Date(now.getFullYear(), now.getMonth(), 1);
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            } else if (type === 'lastMonth') {
                start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                end = new Date(now.getFullYear(), now.getMonth(), 0);
            }
            document.getElementById('filter-start').value = start.toISOString().split('T')[0];
            document.getElementById('filter-end').value = end.toISOString().split('T')[0];
            applyFilter();
        }

        function applyFilter() {
            const startVal = document.getElementById('filter-start').value;
            const endVal = document.getElementById('filter-end').value;
            if(!startVal || !endVal) return Swal.fire('Oops', 'Mohon pilih Tanggal Awal dan Akhir.', 'warning');
            const d1 = new Date(startVal);
            const d2 = new Date(endVal);
            const diffDays = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24)); 
            if (diffDays > 31) return Swal.fire('Range Terlalu Besar', 'Maksimal rentang waktu adalah 31 hari.', 'warning');
            if (d1 > d2) return Swal.fire('Salah Tanggal', 'Tanggal awal tidak boleh lebih besar.', 'error');
            loadStats(startVal, endVal);
        }

        async function handleAuth() {
            const user = document.getElementById('auth-user').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            const btn = document.getElementById('auth-btn');
            if(!user || !pass) return Swal.fire('Oops!', 'Username & Password wajib diisi.', 'warning');
            btn.innerText = "⏳ Memverifikasi..."; btn.disabled = true;
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: isLoginMode ? 'login' : 'signup', user, pass }) });
                const result = await res.json();
                if(result.status === 'success') {
                    localStorage.setItem('gotravel_admin_session', 'active');
                    document.getElementById('auth-overlay').style.display = 'none';
                    setQuickDate('thisMonth');
                } else { Swal.fire('Gagal', result.message, 'error'); }
            } catch(e) { Swal.fire('Error', 'Gagal menghubungi server.', 'error'); }
            btn.innerText = isLoginMode ? "Masuk Sekarang" : "Buat Akun"; btn.disabled = false;
        }

        function handleLogout() { localStorage.removeItem('gotravel_admin_session'); location.reload(); }
        
        function switchAuth() {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').innerText = isLoginMode ? "Login Admin" : "Daftar Admin";
            document.getElementById('auth-btn').innerText = isLoginMode ? "Masuk Sekarang" : "Buat Akun";
            document.getElementById('auth-switch-text').innerText = isLoginMode ? "Belum punya akun?" : "Sudah punya akun?";
            document.getElementById('auth-switch-btn').innerText = isLoginMode ? "Daftar Admin" : "Login Sekarang";
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('active');
            lucide.createIcons();
            if(tabId === 'dashboard' && !document.getElementById('filter-start').value) setQuickDate('thisMonth');
        }

        function addSlot(containerId, className) {
            const input = document.createElement('input');
            input.type = "text"; input.className = `input-box ${className} mt-2`; input.placeholder = "https://...";
            document.getElementById(containerId).appendChild(input);
        }

        async function saveData(type) {
            const btn = document.getElementById('btn-save-' + type);
            const originalText = btn.innerText;
            btn.innerText = "⏳ Menyimpan..."; btn.disabled = true;

            let payload = { action: "" };
            try {
                if (type === 'paket') {
                    const photos = Array.from(document.querySelectorAll('.p-photo-url')).map(i => i.value).filter(v => v);
                    payload = {
                        action: "addProduct",
                        kategori: document.getElementById('p-kat').value,
                        judul: document.getElementById('p-judul').value,
                        desc: document.getElementById('p-desc').value,
                        map: document.getElementById('p-map').value, // KIRIM DATA MAP KE GSHEET
                        h1: document.getElementById('p-h1').value || "0",
                        h2: document.getElementById('p-h2').value || "0",
                        h3: document.getElementById('p-h3').value || "0",
                        foto: photos.join(','),
                        isbestseller: document.getElementById('p-best').value
                    };
                } else if (type === 'tim') {
                    payload = { action: "addTeam", nama: document.getElementById('t-nama').value, jabatan: document.getElementById('t-jab').value, foto: document.getElementById('t-foto').value };
                } else if (type === 'gallery') {
                    payload = { action: "addGallery", kategori: document.getElementById('g-kat').value, produk: document.getElementById('g-produk').value, waktu: new Date().toLocaleDateString('id-ID'), foto: document.getElementById('g-foto').value };
                } else if (type === 'berita') {
                    const newsPhotos = Array.from(document.querySelectorAll('.b-photo-url')).map(i => i.value).filter(v => v);
                    payload = {
                        action: "addNews",
                        judul: document.getElementById('b-judul').value,
                        kategori: document.getElementById('b-kategori').value,
                        foto: newsPhotos.join(','),
                        isi: document.getElementById('b-isi').value
                    };
                }

                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();
                if(result.status === 'success') Swal.fire({ icon: 'success', title: 'Berhasil!', text: 'Data telah disimpan.', confirmButtonColor: '#f97316' });
                else Swal.fire('Gagal', result.message, 'error');
            } catch(e) { Swal.fire('Error', 'Gagal mengirim data.', 'error'); }
            btn.innerText = originalText; btn.disabled = false;
        }

        async function loadStats(startDate = '', endDate = '') {
            document.getElementById('stat-sales').innerText = "...";
            document.getElementById('stat-revenue').innerText = "...";
            try {
                const url = `${SCRIPT_URL}?action=getAdminStats&start=${startDate}&end=${endDate}`;
                const res = await fetch(url);
                const data = await res.json();
                document.getElementById('stat-sales').innerText = data.totalSales || 0;
                document.getElementById('stat-revenue').innerText = "Rp " + (data.totalRevenue || 0).toLocaleString('id-ID');
                initChart(data.chartLabels, data.chartValues); 
            } catch(e) { 
                document.getElementById('stat-sales').innerText = "0";
                document.getElementById('stat-revenue').innerText = "Rp 0";
            }
        }

        function initChart(labels, values) {
            const ctx = document.getElementById('orderChart').getContext('2d');
            if(orderChartInstance) orderChartInstance.destroy();
            let gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(249, 115, 22, 0.8)');
            gradient.addColorStop(1, 'rgba(249, 115, 22, 0.1)');
            orderChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels || [],
                    datasets: [{ 
                        label: 'Jumlah Pesanan', 
                        data: values || [], 
                        backgroundColor: gradient,
                        borderColor: '#f97316',
                        borderWidth: 3,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#f97316',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4 
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { stepSize: 1 } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        window.onload = () => {
            lucide.createIcons();
            if (localStorage.getItem('gotravel_admin_session') === 'active') {
                document.getElementById('auth-overlay').style.display = 'none';
                setQuickDate('thisMonth');
            }
        };
    </script>
</body>
</html>